<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão 2ª Cia do 18º BPM/I</title>
  <style>
    :root{
      --amarelo:#FFFF00;
      --amarelo-neon:#f9ff7a;
      --cinza:#ccc;
      --cinza-medio:#777;
      --bg:#000;
      --card-bg:rgba(10,10,15,0.96);
      --gap:20px;
      --radius:18px;
      --banner-max-h:clamp(420px,72vh,860px);
      --banner-max-h-sm:clamp(260px,55vh,520px);
      --dur:5000ms;
      --fade:1500ms;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      min-height:100vh;
      font-family:Arial,Helvetica,sans-serif;
      color:var(--amarelo);
      background:
        radial-gradient(circle at top, #222 0, #000 55%) fixed;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:16px 8px;
      overflow-x:hidden;
    }

    h1,h2{
      margin:0 0 10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.06em;
    }

    /* ====== SHELL / MOLDURA GERAL (APENAS APÓS LOGIN) ====== */

    #siteConteudo{
      display:none;
      width:100%;
    }

    .app-shell{
      width:100%;
      display:flex;
      justify-content:center;
    }

    .frame{
      position:relative;
      width:100%;
      max-width:1800px;
      border-radius:28px;
      padding:32px 20px 16px;
      background:
        radial-gradient(circle at top,#151515 0,#050509 45%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(255,255,0,0.18),
        0 0 35px rgba(0,0,0,0.9),
        0 0 120px rgba(255,255,0,0.16);
      overflow:hidden;
    }

    .frame::before,
    .frame::after{
      content:"";
      position:absolute;
      inset:16px;
      border-radius:20px;
      border:1px solid rgba(255,255,0,0.3);
      opacity:.5;
      pointer-events:none;
    }

    .frame::after{
      inset:32px 40px 40px;
      border-color:rgba(255,255,255,0.06);
      box-shadow:0 0 40px rgba(0,0,0,0.8) inset;
    }

    .brasao-header{
      position:absolute;
      top:-35px;
      left:50%;
      transform:translateX(-50%);
      height:200px;
      max-width:300px;
      object-fit:contain;
      z-index:4;
      pointer-events:none;
      filter:drop-shadow(0 0 12px rgba(0,0,0,0.9));
    }

    .frame-header{
      position:relative;
      z-index:3;
      padding:32px 24px 16px;
    }

    .header-top-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:18px;
    }

    .header-left{
      max-width:55%;
    }

    .titulo-sistema{
      font-size:1.4rem;
    }

    .subtitulo-sistema{
      margin:0;
      font-size:.9rem;
      color:var(--cinza);
      text-transform:none;
      letter-spacing:.03em;
    }

    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      min-width:210px;
    }

    .badge-sistema{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:6px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,0,0.7);
      background:linear-gradient(135deg,rgba(255,255,0,0.16),rgba(0,0,0,0.7));
      box-shadow:0 0 12px rgba(255,255,0,0.25);
      white-space:nowrap;
    }

    .context-bar{
      margin-top:14px;
      padding:6px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,0,0.25);
      background:linear-gradient(90deg,rgba(255,255,0,0.06),rgba(0,0,0,0.8));
      font-size:.78rem;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      color:var(--cinza);
      text-align:center;
    }
    .context-dot{
      width:4px;
      height:4px;
      border-radius:50%;
      background:var(--amarelo);
      opacity:.9;
    }

    /* ===== Login (tela cheia) ===== */
    #loginBox{
      position:fixed;
      inset:0;
      z-index:99;
      background:
        radial-gradient(circle at top,#202020 0,#000 55%);
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px;
    }

    .login-card{
      position:relative;
      background:var(--card-bg);
      border-radius:22px;
      padding:28px 24px 22px;
      width:min(420px,100%);
      box-shadow:
        0 0 0 1px rgba(255,255,0,0.25),
        0 20px 60px rgba(0,0,0,0.95);
      text-align:center;
      overflow:hidden;
    }

    .login-card::before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.07);
      pointer-events:none;
    }

    .login-card h1{
      margin:0 0 6px;
      font-size:1.4rem;
      text-transform:uppercase;
      letter-spacing:.12em;
    }

    .login-card p{
      color:var(--cinza);
      margin:0 0 18px;
      font-size:.9rem;
    }

    .login-card input{
      width:100%;
      padding:10px 11px;
      margin:6px 0;
      border-radius:10px;
      border:1px solid #333;
      background:#050509;
      color:#fff;
      font-size:.95rem;
    }

    .login-card input:focus{
      outline:none;
      border-color:var(--amarelo);
      box-shadow:0 0 0 1px rgba(255,255,0,0.4);
    }

    .login-card button{
      background:var(--amarelo);
      color:#000;
      border:none;
      border-radius:999px;
      padding:9px 22px;
      font-weight:bold;
      font-size:.95rem;
      cursor:pointer;
      margin-top:10px;
      transition:transform .18s,box-shadow .18s,background .18s;
      box-shadow:0 0 14px rgba(255,255,0,0.55);
    }

    .login-card button:hover{
      background:var(--amarelo-neon);
      transform:translateY(-1px);
      box-shadow:0 0 22px rgba(255,255,0,0.75);
    }

    .erro{
      color:#f66;
      font-size:.85rem;
      min-height:1.1em;
      margin-top:8px;
    }

    footer{
      margin-top:22px;
      font-size:.8rem;
      color:var(--cinza);
      text-align:center;
    }

    /* ===== topo / banner principal ===== */

    .hero-section{
      padding:6px 24px 18px;
      position:relative;
      z-index:2;
    }

    .banner-box{
      width:100%;
      height:var(--banner-max-h);
      background:radial-gradient(circle at top,#1b1b1b 0,#050509 50%,#000 100%);
      overflow:hidden;
      border-radius:20px;
      position:relative;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 18px 60px rgba(0,0,0,0.85);
    }

    .banner{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }

    /* botões topo (registro / sair) */
    .top-actions{
      position:absolute;
      top:14px;
      right:16px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:5;
    }

    .btn{
      background:var(--amarelo);
      color:#000;
      border:none;
      border-radius:999px;
      padding:6px 14px;
      font-weight:bold;
      font-size:.8rem;
      cursor:pointer;
      transition:transform .18s,box-shadow .18s,background .18s,color .18s;
      white-space:nowrap;
    }

    .btn:hover{
      background:var(--amarelo-neon);
      transform:translateY(-1px);
      box-shadow:0 0 16px rgba(255,255,0,0.75);
    }

    .btn.sec{
      background:transparent;
      color:var(--amarelo);
      border:1px solid rgba(255,255,0,0.7);
      box-shadow:none;
    }

    .btn.sec:hover{
      background:rgba(255,255,0,0.08);
      box-shadow:0 0 14px rgba(255,255,0,0.4);
    }

    /* ===== seção de atalhos (Módulos de Trabalho) ===== */

    main{
      padding:8px 24px 10px;
      position:relative;
      z-index:2;
    }

    .section-title{
      margin:12px 0 6px;
      font-size:1.05rem; /* levemente maior */
    }

    .section-sub{
      margin:0 0 16px;
      font-size:.82rem;
      color:var(--cinza-medio);
      text-transform:none;
      letter-spacing:.03em;
    }

    .link-section{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:var(--gap);
      margin:6px 0 26px;
    }

    .link-card{
      text-decoration:none;
      color:inherit;
    }

    /* módulos de trabalho */
    .link-card figure{
      margin:0;
      padding:12px 14px 14px;
      border-radius:18px;
      background:radial-gradient(circle at top,#202020 0,#050509 55%,#000 100%);
      border:1px solid rgba(255,255,255,0.07);
      box-shadow:0 12px 30px rgba(0,0,0,0.9);
      width:250px;
      max-width:280px;
      transition:transform .2s,box-shadow .2s,border-color .2s;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .link-card img{
      width:100px;
      height:100px;
      object-fit:contain;
      border-radius:14px;
      margin-bottom:10px;
      filter:drop-shadow(0 0 12px rgba(0,0,0,0.9));
    }

    .caption{
      font-size:.95rem;
      color:var(--amarelo);
      text-align:center;
    }

    .link-card figure:hover{
      transform:translateY(-3px) scale(1.03);
      border-color:rgba(255,255,0,0.7);
      box-shadow:
        0 0 0 1px rgba(255,255,0,0.25),
        0 18px 45px rgba(0,0,0,0.95);
    }

    /* ===== Destaques do mês (diminuído) ===== */

    .destaque-section{
      margin:0 0 18px;
    }

    .destaque-title{
      text-align:left;
      font-size:.92rem;
    }

    .destaque-banner{
      margin-top:8px;
      margin-left:auto;
      margin-right:auto;
      width:100%;
      max-width:800px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.07);
      background:#050509;
      box-shadow:0 10px 32px rgba(0,0,0,0.85);
    }

    .destaque-banner img{
      width:100%;
      display:block;
      object-fit:contain;
    }

    /* ===== Galeria / Slideshow ===== */

    .galeria-section{
      margin:0 0 12px;
    }

    .slideshow-wrap{
      width:100%;
      height:var(--banner-max-h);
      display:flex;
      justify-content:center;
      align-items:center;
      background:radial-gradient(circle at top,#1b1b1b 0,#050509 50%,#000 100%);
      overflow:hidden;
      border-radius:20px;
      position:relative;
      box-shadow:0 18px 60px rgba(0,0,0,0.9);
      border:1px solid rgba(255,255,255,0.06);
    }

    .slideshow{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
    }

    .slide{
      position:absolute;
      inset:0;
      opacity:0;
      transition:opacity var(--fade) ease-in-out;
    }

    .slide::before{
      content:"";
      position:absolute;
      inset:0;
      background-image:var(--bg-img,none);
      background-size:cover;
      background-position:center;
      filter:blur(24px) brightness(0.55);
      transform:scale(1.1);
    }

    .slide img{
      position:relative;
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      user-select:none;
    }

    .slide.active{opacity:1;}

    .dots{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      display:flex;
      gap:8px;
      z-index:5;
    }

    .dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:rgba(255,255,255,.4);
      transition:transform .2s,background .2s,box-shadow .2s;
    }

    .dot.active{
      background:#fff;
      transform:scale(1.25);
      box-shadow:0 0 10px rgba(255,255,255,0.8);
    }

    .arrow{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      font-size:1.7rem;
      color:#fff;
      background:rgba(0,0,0,0.55);
      border:none;
      padding:8px 13px;
      border-radius:999px;
      cursor:pointer;
      z-index:6;
      transition:background .18s,transform .18s,box-shadow .18s;
    }

    .arrow:hover{
      background:rgba(255,255,255,0.2);
      box-shadow:0 0 18px rgba(0,0,0,0.9);
      transform:translateY(-50%) scale(1.04);
    }

    .arrow.left{left:18px;}
    .arrow.right{right:18px;}

    .frame-footer{
      margin-top:16px;
      padding:4px 24px 4px;
      border-top:1px solid rgba(255,255,255,0.08);
      font-size:.78rem;
      color:var(--cinza);
      text-align:right;
    }

    dialog#audit-modal{
      border:none;
      border-radius:18px;
      max-width:980px;
      width:95%;
      padding:0;
      background:#050509;
      color:var(--amarelo);
      box-shadow:
        0 0 0 1px rgba(255,255,0,0.3),
        0 25px 80px rgba(0,0,0,0.95);
    }

    dialog::backdrop{
      background:rgba(0,0,0,0.8);
      backdrop-filter:blur(2px);
    }

    /* ========== AJUSTES MOBILE ========== */

    @media (max-width:900px){
      body{
        padding:10px 4px;
      }

      .frame{
        padding:88px 12px 10px;          /* espaço extra pro brasão */
      }

      .frame::before{
        inset:26px 12px 20px;
      }

      .frame::after{
        inset:36px 18px 26px;
      }

      .brasao-header{
        top:8px;
        height:90px;
      }

      .frame-header{
        padding:6px 16px 12px;
      }

      .header-top-row{
        flex-direction:column;
        align-items:flex-start;
        gap:10px;
      }

      .header-left{
        max-width:100%;
      }

      .titulo-sistema{
        font-size:1.1rem;
      }

      .hero-section,
      main{
        padding:6px 12px 12px;
      }

      /* banner + slideshow mais baixos no mobile */
      .banner-box,
      .slideshow-wrap{
        height:var(--banner-max-h-sm);
      }

      /* pastas: 2 por linha, sem rolagem lateral */
      .link-section{
        justify-content:center;
        gap:14px;
      }

      .link-card figure{
        width:calc(50% - 10px);
        max-width:260px;
      }

      .top-actions{
        top:10px;
        right:10px;
      }

      .badge-sistema{
        font-size:.7rem;
      }
    }

    @media (max-width:600px){
      .frame{
        padding:96px 10px 10px;          /* mais um pouco pro brasão + título */
      }

      .brasao-header{
        top:10px;
        height:82px;
      }

      .section-title{
        font-size:.95rem;
      }

      .context-bar{
        font-size:.72rem;
        flex-wrap:wrap;
        row-gap:4px;
      }

      /* pastas: 1 por linha no celular */
      .link-card figure{
        width:100%;
        max-width:none;
      }

      .arrow{
        font-size:1.5rem;
        padding:6px 10px;
      }
    }
  </style>
</head>
<body>

<!-- Login -->
<div id="loginBox">
  <div class="login-card">
    <h1>Acesso Restrito</h1>
    <p>Ambiente interno da 2ª Companhia – informe usuário e senha</p>
    <form id="formLogin">
      <input id="usuario" placeholder="Usuário" required>
      <input id="senha" type="password" placeholder="Senha" required>
      <button type="submit">Entrar</button>
      <div class="erro" id="erro"></div>
    </form>
    <footer>&copy; 2025 - 18º BPM/I • Uso interno</footer>
  </div>
</div>

<!-- Conteúdo do site (oculto até login) -->
<div id="siteConteudo">
  <div class="app-shell">
    <div class="frame">
      <!-- brasão central na moldura -->
      <img src="brasao18.png" alt="Brasão 18º BPM/I" class="brasao-header">

      <!-- Cabeçalho -->
      <header class="frame-header">
        <div class="header-top-row">
          <div class="header-left">
            <h1 class="titulo-sistema">Gestão 2ª Cia do 18º BPM/I</h1>
            <p class="subtitulo-sistema">
              Sistema de gestão operacional e administrativa com acesso controlado.
            </p>
          </div>
          <div class="header-right">
            <span class="badge-sistema">Sistema de Gestão • Uso Interno</span>
            <!-- botões de topo (registro / sair) -->
            <div class="top-actions">
              <button id="btn-audit-open" class="btn sec" style="display:none">Registro de Acessos</button>
              <button onclick="sair()" class="btn">Sair</button>
            </div>
          </div>
        </div>

        <div class="context-bar">
          <span>2ª Companhia</span>
          <span class="context-dot"></span>
          <span>18º BPM/I – Policiamento Ostensivo</span>
          <span class="context-dot"></span>
          <span>Ambiente monitorado de acessos</span>
        </div>
      </header>

      <!-- Banner topo -->
      <section class="hero-section">
        <div class="banner-box">
          <img src="topo.png" class="banner" alt="Topo 18º BPM/I">
        </div>
      </section>

      <!-- Conteúdo principal -->
      <main>
        <!-- Atalhos -->
        <section>
          <h2 class="section-title">Módulos de Trabalho</h2>
          <p class="section-sub">
            Acesse as planilhas e pastas operacionais da 2ª Companhia de forma rápida e organizada.
          </p>
          <div class="link-section">
            <a class="link-card" href="https://docs.google.com/spreadsheets/d/18vwJtRh2IAvsJvNEZtA1uSpHikW7cmuAwsfhUVTBr7c/edit?usp=sharing" target="_blank">
              <figure>
                <img src="pasta.png" alt="Análise criminal">
                <figcaption class="caption"><strong>Análise Criminal</strong></figcaption>
              </figure>
            </a>
            <a class="link-card" href="https://drive.google.com/drive/folders/1xxyhzChozUNIYozhkGogJ4KkYixGolxr?usp=sharing" target="_blank">
              <figure>
                <img src="pasta.png" alt="Ordens de Serviço">
                <figcaption class="caption"><strong>Ordens de Serviço</strong></figcaption>
              </figure>
            </a>
            <a class="link-card" href="https://docs.google.com/spreadsheets/d/1_zKAEUIgF3DDnoMevwvCrqaIh-WtNQLvO2SQXovu_eU/edit?usp=sharing" target="_blank">
              <figure>
                <img src="pasta.png" alt="QAP">
                <figcaption class="caption"><strong>QAP</strong></figcaption>
              </figure>
            </a>
            <a class="link-card" href="https://docs.google.com/spreadsheets/d/1vT0B7PhLwElgYQEa6M0eUGQpP7EVnrSmxamf0QEB8wI/edit?usp=sharing" target="_blank">
              <figure>
                <img src="pasta.png" alt="Mapa de Viaturas">
                <figcaption class="caption"><strong>Mapa de Viaturas</strong></figcaption>
              </figure>
            </a>
            <a class="link-card" href="https://docs.google.com/spreadsheets/d/1BJcYe9m4GlRPfonB_W-LmM8ivXj1J2SG2QUO3hMnPeE/edit?usp=sharing" target="_blank">
              <figure>
                <img src="pasta.png" alt="Planejamento DEJEM">
                <figcaption class="caption"><strong>Planejamento DEJEM</strong></figcaption>
              </figure>
            </a>
            <a class="link-card" href="https://drive.google.com/drive/folders/1U_z4u6RuZcPWkgD3hQbueoDJdTgxXs8U?usp=sharing" target="_blank">
              <figure>
                <img src="pasta.png" alt="Escalas">
                <figcaption class="caption"><strong>ESCALAS</strong></figcaption>
              </figure>
            </a>
          </div>
        </section>

        <!-- Destaques (menor) -->
        <section class="destaque-section">
          <h2 class="section-title destaque-title">Destaques do mês</h2>
          <div class="destaque-banner">
            <img src="pmdomes.png" alt="Policial(es) do mês">
          </div>
        </section>

        <!-- Galeria / Slideshow -->
        <section class="galeria-section">
          <h2 class="section-title">Galeria de fotos</h2>
          <p class="section-sub">
            Registros das principais operações e ações da 2ª Companhia.
          </p>
          <div class="slideshow-wrap">
            <div class="slideshow" id="slideshow">
              <figure class="slide active"><img src="foto1.jpg" alt=""></figure>
              <figure class="slide"><img src="foto2.jpg" alt=""></figure>
              <figure class="slide"><img src="foto3.jpg" alt=""></figure>
              <figure class="slide"><img src="foto4.jpg" alt=""></figure>
              <figure class="slide"><img src="foto5.jpg" alt=""></figure>
              <figure class="slide"><img src="foto6.jpg" alt=""></figure>
              <figure class="slide"><img src="foto7.jpg" alt=""></figure>
              <figure class="slide"><img src="foto8.jpg" alt=""></figure>
              <figure class="slide"><img src="foto9.jpg" alt=""></figure>

              <button class="arrow left" id="prev">&#10094;</button>
              <button class="arrow right" id="next">&#10095;</button>
              <div class="dots" id="dots"></div>
            </div>
          </div>
        </section>
      </main>

      <div class="frame-footer">
        &copy; 2025 - 18º Batalhão da Polícia Militar do Interior • 2ª Companhia
      </div>
    </div>
  </div>
</div>

<!-- ===== Modal do Registro de Acessos ===== -->
<dialog id="audit-modal">
  <header style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #333">
    <strong style="font-size:18px">Registro de Acessos</strong>
    <button id="audit-close" class="btn sec">Fechar</button>
  </header>

  <section style="padding:12px 20px;display:grid;gap:12px">
    <!-- Filtros -->
    <div style="display:grid;gap:8px;grid-template-columns:repeat(6,minmax(0,1fr));align-items:end">
      <div style="grid-column:span 2">
        <label for="fil-user">Usuário</label>
        <input id="fil-user" placeholder="ex.: fenille" style="width:100%;padding:6px;background:#111;color:#FFFF00;border:1px solid #333;border-radius:8px">
      </div>
      <div>
        <label for="fil-event">Evento</label>
        <select id="fil-event" style="width:100%;padding:6px;background:#111;color:#FFFF00;border:1px solid #333;border-radius:8px">
          <option value="">(todos)</option>
          <option>login_sucesso</option>
          <option>login_falha</option>
          <option>login_bloqueado</option>
          <option>logout</option>
          <option>auto_logout_inatividade</option>
          <option>sessao_expirada</option>
          <option>acesso_negado</option>
        </select>
      </div>
      <div>
        <label for="fil-d1">De</label>
        <input id="fil-d1" type="date" style="width:100%;padding:6px;background:#111;color:#FFFF00;border:1px solid #333;border-radius:8px">
      </div>
      <div>
        <label for="fil-d2">Até</label>
        <input id="fil-d2" type="date" style="width:100%;padding:6px;background:#111;color:#FFFF00;border:1px solid #333;border-radius:8px">
      </div>
      <div>
        <button id="fil-aplicar" class="btn sec" style="width:100%;">Aplicar</button>
      </div>
      <div>
        <button id="fil-limpar" class="btn sec" style="width:100%;">Limpar filtros</button>
      </div>
    </div>

    <!-- Ações -->
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="audit-export-csv"  class="btn sec">Exportar CSV</button>
      <button id="audit-export-json" class="btn sec">Exportar JSON</button>
      <button id="audit-clear"       class="btn sec" style="margin-left:auto;background:#330000;border-color:#990000;color:#FFFF00">Limpar Registro</button>
    </div>

    <!-- Tabela -->
    <div style="max-height:55vh;overflow:auto;border:1px solid #222;border-radius:10px">
      <table id="audit-table" style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:#111">
            <th style="text-align:left;padding:8px;border-bottom:1px solid #222">Data/Hora</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #222">Usuário</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #222">Role</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #222">Evento</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #222">Detalhes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</dialog>

<script>
/* ================== Login e usuários ================== */
const usuarios = {
  "fenille": "Tatico25",
  "analista": "ocorrencia#destaque",

  "140965": "140965",
  "picinin": "picinin",
  "139041": "139041",
  "963863": "963863",
  "118072": "118072",
  "894464": "894464",
  "991296": "991296",
  "991315": "991315",
  "126604": "126604",
  "130273": "130273",
  "133736": "133736",
  "138402": "138402",
  "963846": "963846",
  "963897": "963897",
  "103364": "103364",
  "151785": "151785",
  "961846": "961846",
  "975829": "975829",
  "980369": "980369",
  "982571": "982571",
  "991278": "991278",
  "992151": "992151",
  "992207": "992207",
  "992214": "992214",
  "100153": "100153",
  "102633": "102633",
  "104690": "104690",
  "106001": "106001",
  "106080": "106080",
  "106109": "106109",
  "107785": "107785",
  "108753": "108753",
  "109812": "109812",
  "110206": "110206",
  "110251": "110251",
  "110263": "110263",
  "110272": "110272",
  "110304": "110304",
  "110306": "110306",
  "110312": "110312",
  "113857": "113857",
  "114004": "114004",
  "118350": "118350",
  "118634": "118634",
  "119457": "119457",
  "120145": "120145",
  "122385": "122385",
  "124948": "124948",
  "125817": "125817",
  "126213": "126213",
  "129261": "129261",
  "132800": "132800",
  "132223": "132223",
  "133069": "133069",
  "134504": "134504",
  "134775": "134775",
  "137016": "137016",
  "139093": "139093",
  "139544": "139544",
  "140839": "140839",
  "141128": "141128",
  "141321": "141321",
  "141366": "141366",
  "141549": "141549",
  "143540": "143540",
  "144106": "144106",
  "144384": "144384",
  "145843": "145843",
  "145903": "145903",
  "145988": "145988",
  "148491": "148491",
  "148512": "148512",
  "151742": "151742",
  "152845": "152845",
  "156453": "156453",
  "157284": "157284",
  "170571": "170571",
  "171625": "171625",
  "180445": "180445",
  "190996": "190996",
  "192457": "192457",
  "147082": "147082",
  "147780": "147780",
  "149091": "149091",
  "150933": "150933",
  "150934": "150934",
  "151188": "151188",
  "154870": "154870",
  "155436": "155436",
  "156189": "156189",
  "156472": "156472",
  "156579": "156579",
  "157853": "157853",
  "161839": "161839",
  "162276": "162276",
  "171268": "171268",
  "171729": "171729",
  "180904": "180904",
  "191753": "191753",
  "193398": "193398",
  "127971": "127971",
  "191234": "191234",
  "191921": "191921",
  "104547": "104547",
  "192696": "192696"
};

const loginBox = document.getElementById("loginBox");
const siteConteudo = document.getElementById("siteConteudo");
const erro = document.getElementById("erro");
const btnAuditOpen = document.getElementById("btn-audit-open");

const userStored = sessionStorage.getItem("authUser");
if (userStored) {
  mostrarSite(userStored);
} else {
  loginBox.style.display = "flex";
}

document.getElementById("formLogin").addEventListener("submit", async (e) => {
  e.preventDefault();
  const uRaw = document.getElementById("usuario").value.trim();
  const u = uRaw.toLowerCase();
  const s = document.getElementById("senha").value;

  if (usuarios[u] && usuarios[u] === s) {
    sessionStorage.setItem("authUser", u);
    pushLog("login_sucesso", { user: u });
    await registrarAcesso({ usuario: u, sucesso: true, extra: 'login_ok', evento: 'login_sucesso' });
    mostrarSite(u);
  } else {
    erro.textContent = "Usuário ou senha incorretos.";
    pushLog("login_falha", { user: u });
    await registrarAcesso({ usuario: u || '(vazio)', sucesso: false, extra: 'senha_invalida', evento: 'login_falha' });
  }
});

function mostrarSite(u){
  loginBox.style.display = "none";
  siteConteudo.style.display = "block";

  if (u === "fenille" || u === "analista") {
    btnAuditOpen.style.display = "inline-block";
  } else {
    btnAuditOpen.style.display = "none";
  }
}

async function sair() {
  const u = sessionStorage.getItem("authUser");
  if (u) {
    pushLog("logout", { user: u });
    await registrarAcesso({ usuario: u, sucesso: true, extra: 'logout', evento: 'logout' });
  }
  sessionStorage.clear();
  location.reload();
}

/* ================== Registro de Acessos ================== */
const KEY_LOG = "gestao18_auditlog";
function salvar(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function ler(key, def=null){ try { return JSON.parse(localStorage.getItem(key)) ?? def; } catch { return def; } }

function deviceInfo(){
  return {
    ua: navigator.userAgent,
    lang: navigator.language,
    scr: `${window.screen?.width ?? '?'}x${window.screen?.height ?? '?'}`,
    tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'local',
  };
}
function pushLog(evento, extra={}){
  const logs = ler(KEY_LOG, []);
  logs.push({
    ts: new Date().toISOString(),
    evento,
    role: extra.role || "-",
    ...extra,
    ...deviceInfo()
  });
  salvar(KEY_LOG, logs.slice(-2000));
}

/* ===== Integração com Google Sheets ===== */
const AUDIT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwMJGNOgtKFLTp7RJKFgFE_j_5UbvX196uEj21_MI3l524flrc9fXgVZkTszr26SH8MFg/exe';

async function logAcessoRemoto({ usuario, sucesso, page = location.pathname, extra = '', evento = '' }) {
  try {
    const payload = {
      usuario: String(usuario || '').trim(),
      sucesso: !!sucesso,
      userAgent: navigator.userAgent,
      page,
      extra: extra || evento || ''
    };
    await fetch(AUDIT_ENDPOINT, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (e) {
    console.warn('Falha ao registrar no servidor:', e);
  }
}

async function registrarAcesso({ usuario, sucesso, extra = '', evento = '' }) {
  await logAcessoRemoto({ usuario, sucesso, extra, evento });
}

/* ===== UI do modal de auditoria ===== */
const $auditModal = document.querySelector("#audit-modal");
const $auditClose = document.querySelector("#audit-close");
const $auditTbl   = document.querySelector("#audit-table tbody");

const $filUser   = document.querySelector("#fil-user");
const $filEvent  = document.querySelector("#fil-event");
const $filD1     = document.querySelector("#fil-d1");
const $filD2     = document.querySelector("#fil-d2");
const $filAplic  = document.querySelector("#fil-aplicar");
const $filLimpar = document.querySelector("#fil-limpar");

const $expCSV = document.querySelector("#audit-export-csv");
const $expJSON= document.querySelector("#audit-export-json");
const $clear  = document.querySelector("#audit-clear");

btnAuditOpen?.addEventListener("click", ()=> { renderAudit(); $auditModal?.showModal(); });
$auditClose?.addEventListener("click", ()=> $auditModal?.close());

function getFilteredLogs(){
  let data = ler(KEY_LOG, []);
  const u = ($filUser.value || "").trim().toLowerCase();
  const e = $filEvent.value || "";
  const d1 = $filD1.value ? new Date($filD1.value + "T00:00:00") : null;
  const d2 = $filD2.value ? new Date($filD2.value + "T23:59:59") : null;

  return data.filter(item=>{
    if(u && !(String(item.user||"").toLowerCase().includes(u))) return false;
    if(e && item.evento !== e) return false;
    const t = new Date(item.ts);
    if(d1 && t < d1) return false;
    if(d2 && t > d2) return false;
    return true;
  }).sort((a,b)=> new Date(b.ts)-new Date(a.ts));
}

function renderAudit(){
  const rows = getFilteredLogs();
  $auditTbl.innerHTML = rows.map(r=>{
    const detalhes = [];
    if(r.alvo) detalhes.push(`alvo=${r.alvo}`);
    if(r.tentativas!=null) detalhes.push(`tentativas=${r.tentativas}`);
    if(r.lang) detalhes.push(`lang=${r.lang}`);
    if(r.scr)  detalhes.push(`scr=${r.scr}`);
    if(r.tz)   detalhes.push(`tz=${r.tz}`);
    const det = detalhes.join(" • ");
    const when = new Date(r.ts).toLocaleString();
    return `<tr>
      <td style="padding:8px;border-bottom:1px solid #222">${when}</td>
      <td style="padding:8px;border-bottom:1px solid #222">${r.user ?? "-"}</td>
      <td style="padding:8px;border-bottom:1px solid #222">${r.role ?? "-"}</td>
      <td style="padding:8px;border-bottom:1px solid #222">${r.evento}</td>
      <td style="padding:8px;border-bottom:1px solid #222;font-size:12px;color:#ccc">${det}</td>
    </tr>`;
  }).join("");
}

$filAplic?.addEventListener("click", renderAudit);
$filLimpar?.addEventListener("click", ()=>{
  $filUser.value = "";
  $filEvent.value= "";
  $filD1.value   = "";
  $filD2.value   = "";
  renderAudit();
});

function download(filename, content, type="text/plain"){
  const blob = new Blob([content], {type});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}

$expCSV?.addEventListener("click", ()=>{
  const rows = getFilteredLogs();
  const header = ["ts","evento","user","role","alvo","tentativas","ua","lang","scr","tz"];
  const csv = [header.join(",")].concat(rows.map(r=> header.map(k=>{
    const v = (r[k] ?? "").toString().replaceAll('"','"');
    return `"${v}"`;
  }).join(","))).join("\n");
  const stamp = new Date().toISOString().replace(/[:.]/g,"-");
  download(`registro-acessos-${stamp}.csv`, csv, "text/csv");
});

$expJSON?.addEventListener("click", ()=>{
  const rows = getFilteredLogs();
  const stamp = new Date().toISOString().replace(/[:.]/g,"-");
  download(`registro-acessos-${stamp}.json`, JSON.stringify(rows, null, 2), "application/json");
});

$clear?.addEventListener("click", ()=>{
  if(confirm("Apagar TODO o registro de acessos? Esta ação não pode ser desfeita.")){
    salvar(KEY_LOG, []);
    renderAudit();
  }
});

/* ================== Slideshow ================== */
(function(){
  const slideshow = document.getElementById('slideshow');
  if (!slideshow) return;
  const slides = Array.from(slideshow.querySelectorAll('.slide'));
  const dotsWrap = document.getElementById('dots');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');
  let index = 0, timer = null, DURATION = 5000;

  slides.forEach(slide => {
    const img = slide.querySelector('img');
    if (img && img.src) slide.style.setProperty('--bg-img', `url("${img.src}")`);
  });

  slides.forEach((_, i) => {
    const d = document.createElement('span');
    d.className = 'dot' + (i === 0 ? ' active' : '');
    d.addEventListener('click', () => goTo(i, true));
    dotsWrap.appendChild(d);
  });
  const dots = Array.from(dotsWrap.children);

  function setActive(i) {
    slides.forEach((s,k)=>s.classList.toggle('active',k===i));
    dots.forEach((d,k)=>d.classList.toggle('active',k===i));
  }
  function next(){ index=(index+1)%slides.length; setActive(index); }
  function prev(){ index=(index-1+slides.length)%slides.length; setActive(index); }
  function goTo(i,reset){ index=(i+slides.length)%slides.length; setActive(index); if(reset) restart(); }
  function start(){ stop(); timer=setInterval(next,DURATION); }
  function stop(){ if(timer) clearInterval(timer); }
  function restart(){ stop(); start(); }

  btnNext.addEventListener('click',()=>{ next(); restart(); });
  btnPrev.addEventListener('click',()=>{ prev(); restart(); });
  slideshow.addEventListener('mouseenter',stop);
  slideshow.addEventListener('mouseleave',start);
  document.addEventListener('visibilitychange',()=>{ document.hidden?stop():start(); });

  start();
})();
</script>
</body>
</html>
